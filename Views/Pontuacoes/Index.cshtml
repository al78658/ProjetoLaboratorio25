@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <title>Gestão de Resultados</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #808080;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
        }

        .top-left-logo {
            position: absolute;
            top: 40px;
            left: 50px;
        }

            .top-left-logo img {
                width: 160px;
            }

        .content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1000px;
        }

        h2 {
            font-size: 32px;
            color: black;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin-bottom: 30px;
        }

        th, td {
            padding: 14px 12px;
            border: 1px solid #888;
            text-align: center;
            font-size: 18px;
        }

        th {
            background-color: #ccc;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .victory-button {
            padding: 6px 10px;
            background-color: white;
            border: 2px solid #000;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 2px;
        }

            .victory-button:hover {
                background-color: #e0e0e0;
            }

        .arrow-button {
            display: inline-block;
            width: 24px;
            height: 24px;
            background-color: green;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            line-height: 24px;
            margin: 0 4px;
        }

        .comment-section {
            width: 100%;
        }

            .comment-section label {
                font-size: 20px;
                color: black;
            }

        .comment-box {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .confirm-button {
            display: block;
            margin: 30px auto 0 auto;
            font-size: 18px;
            padding: 12px 30px;
            border: 2px solid #000;
            background: white;
            border-radius: 8px;
            cursor: pointer;
        }

            .confirm-button:hover {
                background-color: #dcdcdc;
            }

        .back-button {
            position: absolute;
            right: 40px;
            bottom: 40px;
            padding: 12px 24px;
            font-size: 18px;
            border: 2px solid #000;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            color: black;
        }

            .back-button:hover {
                background-color: #dcdcdc;
            }

        .pontuacao-flex {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
    </style>
</head>
<body>

    <!-- Logotipo -->
    <div class="top-left-logo">
        <a href="/home">
            <img src="img/logotipo.png" alt="Logotipo" />
        </a>
    </div>

    <!-- Conteúdo Centralizado -->
    <div class="content-wrapper">
        <h2>Gestão de Resultados</h2>
        <div style="margin-bottom: 24px; text-align: right;">
            <label for="dataSelecionada" style="font-size:18px; color:black;">Dia: </label>
            <input type="date" id="dataSelecionada" />
        </div>
        <table id="tabelaPontuacoes">
            <thead>
                <tr>
                    <th>Partidas</th>
                    <th>Pontuação</th>
                    <th>Vitória</th>
                    <th>Motivo</th>
                </tr>
            </thead>
            <tbody>
                <!-- Jogos renderizados por JS -->
            </tbody>
        </table>
        <button class="confirm-button" id="btnRegistar">Registar</button>
    </div>
    <a href="/Menu" class="back-button">&lt;Voltar</a>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const nomeCompeticao = localStorage.getItem('competicaoSelecionada');
        const tabela = document.getElementById('tabelaPontuacoes').getElementsByTagName('tbody')[0];
        const dataInput = document.getElementById('dataSelecionada');
        const btnRegistar = document.getElementById('btnRegistar');
        let agendamentos = [];
        let resultados = [];
        // Recebe a data selecionada do menu, se existir
        const dataSelecionadaMenu = localStorage.getItem('dataSelecionadaMenu');
        // Inicializa data selecionada para hoje ou para a vinda do menu
        const hoje = new Date().toISOString().split('T')[0];
        dataInput.value = dataSelecionadaMenu || hoje;
        function carregarAgendamentos() {
            if (nomeCompeticao) {
                agendamentos = JSON.parse(localStorage.getItem('agendamentos_' + nomeCompeticao)) || [];
            } else {
                agendamentos = [];
            }
        }
        function carregarResultados() {
            if (nomeCompeticao && dataInput.value) {
                resultados = JSON.parse(localStorage.getItem('resultados_' + nomeCompeticao + '_' + dataInput.value)) || [];
            } else {
                resultados = [];
            }
        }
        function renderJogos() {
            tabela.innerHTML = '';
            const dataSelecionada = dataInput.value;
            const jogosDoDia = agendamentos.filter(j => j.data === dataSelecionada);
            if (jogosDoDia.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="4">Nenhum jogo agendado para este dia.</td>';
                tabela.appendChild(row);
                return;
            }
            jogosDoDia.forEach((jogo, idx) => {
                const resultado = resultados.find(r => r.jogador1 === jogo.jogador1 && r.jogador2 === jogo.jogador2) || {};
                const pontuacao = resultado.pontuacao || '0-0';
                const vencedor = resultado.vencedor || '';
                const motivo = resultado.motivo || '';
                const v1Active = vencedor === jogo.jogador1 ? 'background:#b6e7b6;' : '';
                const v2Active = vencedor === jogo.jogador2 ? 'background:#b6e7b6;' : '';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${jogo.jogador1} vs ${jogo.jogador2}</td>
                    <td>
                        <div class="pontuacao-flex">
                            <button class="arrow-button" onclick="incrementScore(${idx},1)">↑</button>
                            <span id="score-${idx}">${pontuacao}</span>
                            <button class="arrow-button" onclick="incrementScore(${idx},2)">↑</button>
                        </div>
                    </td>
                    <td>
                        <button class="victory-button" style="${v1Active}" onclick="darVitoria(${idx},'${jogo.jogador1}')">Dar Vitória ${jogo.jogador1}</button>
                        <button class="victory-button" style="${v2Active}" onclick="darVitoria(${idx},'${jogo.jogador2}')">Dar Vitória ${jogo.jogador2}</button>
                    </td>
                    <td><input type="text" class="motivo-input" data-idx="${idx}" value="${motivo}" placeholder="Motivo (obrigatório se vitória)" style="width:140px;" /></td>
                `;
                tabela.appendChild(row);
            });
        }
        window.incrementScore = function(idx, player) {
            const scoreSpan = document.getElementById('score-' + idx);
            let scores = scoreSpan.textContent.split('-').map(Number);
            if (scores.length !== 2) scores = [0,0];
            if (scores[player-1] < 99) scores[player-1]++;
            scoreSpan.textContent = scores.join('-');
        }
        window.darVitoria = function(idx, vencedor) {
            resultados[idx] = resultados[idx] || {};
            resultados[idx].vencedor = vencedor;
            renderJogos();
        }
        dataInput.addEventListener('change', function () {
            carregarResultados();
            renderJogos();
        });
        btnRegistar.addEventListener('click', function () {
            const dataSelecionada = dataInput.value;
            const jogosDoDia = agendamentos.filter(j => j.data === dataSelecionada);
            let erro = false;
            const novosResultados = jogosDoDia.map((jogo, idx) => {
                const score = document.getElementById('score-' + idx).textContent;
                const vencedor = (resultados[idx] && resultados[idx].vencedor) || '';
                const motivo = document.querySelector(`.motivo-input[data-idx='${idx}']`).value.trim();
                if (vencedor && motivo.length < 2) {
                    alert('Para registar vitória é obrigatório um motivo para o jogo: ' + jogo.jogador1 + ' vs ' + jogo.jogador2);
                    erro = true;
                }
                return {
                    jogador1: jogo.jogador1,
                    jogador2: jogo.jogador2,
                    pontuacao: score,
                    vencedor,
                    motivo
                };
            });
            if (erro) return;
            if (nomeCompeticao && dataSelecionada) {
                localStorage.setItem('resultados_' + nomeCompeticao + '_' + dataSelecionada, JSON.stringify(novosResultados));
            }
            window.location.href = '/Menu';
        });
        carregarAgendamentos();
        carregarResultados();
        renderJogos();
    });
    </script>

</body>
</html>
